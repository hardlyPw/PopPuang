<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>팝푸앙</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('/images/software_logo.jpg');
            background-repeat: no-repeat;
            background-size: cover;      /* 화면 꽉 채우기 */
            background-position: center;
            background-attachment: fixed;
        }

        .header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px;
            background-color: #004c97;
        }
        .header form { margin-left: 10px; }
        .header button {
            padding: 8px 16px;
            background-color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .header button:hover { background-color: #bdc3c7; }

        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }

        /* 리더보드 흔들림 방지: 이미지 영역 고정 높이 컨테이너 */
        .image-button {
            margin-top: 160px;     /* 기존 img의 margin-top을 컨테이너로 이동 */
            height: 420px;         /* 원본 400px 기준 여유분 */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        /* 이미지 + 카운터 겹치기 위한 래퍼 */
        .image-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /*중앙정렬*/
        }

        .image-button img {
            width: 400px;
            max-width: 80%;
            height: auto;
            transition: transform 0.15s ease;
            cursor: pointer;
            will-change: transform;       /* transform만 바뀌게 해서 레이아웃 영향 최소화 */
        }
        .image-button img:active { transform: scale(0.97); }
        .image-button img.pop { animation: popBounce 280ms ease; }
        @keyframes popBounce {
            0%   { transform: scale(1); }
            40%  { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* 이미지 위 클릭 카운트 배지 */
        .click-count {
            margin-bottom: 8px;     /* 이미지와의 간격 */
            background-color: rgba(0,0,0,0.6);
            color: #fff;
            padding: 6px 12px;
            border-radius: 18px;
            font-size: 20px;
            font-weight: 800;
            text-shadow: 0 1px 2px rgba(0,0,0,0.35);
            pointer-events: none;
            user-select: none;
        }

        .leaderboard {
            margin-top: 160px;
            width: 80%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .leaderboard h2 {
            margin: 0 0 20px;
            text-align: center;
            color: #2c3e50;
        }
        .leaderboard ul { list-style: none; padding: 0; margin: 0; }
        .leaderboard li {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 1em;
        }
        .leaderboard li:last-child { border-bottom: none; }
    </style>
</head>
<body>
<!-- 상단 헤더 -->
<div class="header">
    <div th:if="${isLoggedIn}">
        <form th:action="@{/logout}" method="post">
            <button type="submit">로그아웃</button>
        </form>
    </div>

    <div th:unless="${isLoggedIn}" style="display: flex;">
        <form th:action="@{/login}" method="get">
            <button type="submit">로그인</button>
        </form>
        <form th:action="@{/register}" method="get">
            <button type="submit">회원가입</button>
        </form>
    </div>
</div> <!-- ← 헤더 닫힘 누락되어 있어 추가 -->

<!-- 중앙 컨텐츠 -->
<div class="center-container">
    <!-- 이미지 버튼 (오버레이 카운터 포함) -->
    <div class="image-button">
        <div class="image-wrapper">
            <div id="clickCount" class="click-count">0</div>
            <img id="puangImg" src="/images/poppuang-closed.png" alt="푸앙이" />

        </div>
    </div>

    <!-- 클릭 사운드: 짧은 효과음은 WAV/OGG 권장 (지금은 요청대로 /images 사용) -->
    <audio id="clickSound" src="/images/pop.mp3" preload="auto"></audio>

    <script>
        const puangImg = document.getElementById('puangImg');
        const clickSound = document.getElementById('clickSound');
        const clickCountEl = document.getElementById('clickCount');
        let revertTimer = null;

        // 볼륨 (0.0~1.0)
        clickSound.volume = 0.9;

        // 카운트 유틸
        function setCount(n) {
            clickCountEl.textContent = Number.isFinite(n) ? n : 0;
        }
        function incCount() {
            const cur = parseInt(clickCountEl.textContent || '0', 10) || 0;
            setCount(cur + 1);
        }

        puangImg.addEventListener('click', () => {
            // 사운드 재생 (사용자 제스처이므로 대부분 브라우저에서 허용)
            try {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
            } catch (_) {}

            // 이미지 열림 + 팝 애니메이션
            puangImg.classList.remove('pop');
            puangImg.src = '/images/poppuang-open.png';
            // 애니메이션 재시작 트릭
            // eslint-disable-next-line no-unused-expressions
            puangImg.offsetWidth;
            puangImg.classList.add('pop');

            // 자동 닫힘
            if (revertTimer) clearTimeout(revertTimer);
            revertTimer = setTimeout(() => {
                puangImg.src = '/images/poppuang-closed.png';
                puangImg.classList.remove('pop');
            }, 200);

            // 클릭 카운트 처리 (서버 응답에 clicks 있으면 사용, 없으면 +1)
            fetch('/click', { method: 'POST' })
                .then(async (res) => {
                    try {
                        const data = await res.json();
                        if (data && typeof data.clicks === 'number') {
                            setCount(data.clicks);
                        } else {
                            incCount();
                        }
                    } catch (e) {
                        incCount();
                    }
                })
                .then(() => loadLeaderboard())
                .catch(err => {
                    console.error(err);
                    incCount();
                });
        });

        // (선택) 초기 카운트 가져오기: /clicks가 있으면 사용, 없으면 0 유지
        function loadInitialCount() {
            fetch('/clicks')
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    if (data && typeof data.clicks === 'number') {
                        setCount(data.clicks);
                    }
                })
                .catch(() => { /* 엔드포인트 없으면 무시 */ });
        }

        // 리더보드 불러오기
        function loadLeaderboard() {
            const ul = document.querySelector('.leaderboard ul');
            ul.innerHTML = `<li>로딩 중...</li>`;
            fetch('/leaderboard')
                .then(res => res.json())
                .then(data => {
                    ul.innerHTML = data.length
                        ? data.map((item, i) =>
                            `<li><span>${i + 1}위</span> <span>${item.major}</span> <span>${item.clicks}</span></li>`
                        ).join('')
                        : `<li>데이터 없음</li>`;
                })
                .catch(err => {
                    console.error('리더보드 로딩 실패:', err);
                    ul.innerHTML = `<li>오류 발생</li>`;
                });
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadInitialCount();  // 선택
            loadLeaderboard();
        });
    </script>

    <!-- 리더보드 -->
    <div class="leaderboard">
        <h2>리더보드</h2>
        <ul></ul>
    </div>
</div>
</body>
</html>
