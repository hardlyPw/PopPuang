<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>팝푸앙</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;

            /* ✅ body 자체의 background 속성은 제거합니다. */

            /* ✅ body에 position: relative; 추가하여 가상요소의 기준점으로 만듭니다. */
            position: relative;

            /* ✅ 내용물이 가상요소 위로 올라오도록 합니다. */
            z-index: 1;
        }

        /* ✅ 배경 이미지를 위한 가상 요소 추가 */
        body::before {
            content: ''; /* 가상 요소 필수 속성 */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* 기존 background 속성들을 이쪽으로 이동 */
            background-image: url('/images/software_logo.jpg');
            background-repeat: no-repeat;
            background-size: 800px auto;

            /* 1. 위쪽 여백 주기 */
            background-position: center 200px; /* 50px는 원하는 만큼 조절 */

            /* 2. 흐림 효과 주기 */
            filter: blur(8px); /* 8px는 원하는 흐림 정도로 조절 */

            /* ✅ 내용 뒤로 보내기 위한 z-index 설정 */
            z-index: -1;

            /* ✅ 일부 브라우저에서 깜빡임 방지를 위한 트릭 */
            transform: scale(1.1);
        }

        .header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px;
            background-color: #004c97;
        }
        .header form {
            margin-left: 10px;
        }

        .header button {
            padding: 8px 16px;
            background-color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .header button:hover {
            background-color: #bdc3c7;
        }

        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }

        /* 리더보드 흔들림 방지: 이미지 영역 고정 높이 컨테이너 */
        .image-button {
            margin-top: 160px;     /* 기존 img의 margin-top을 컨테이너로 이동 */
            height: 420px;         /* 원본 400px 기준 여유분 */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        /* 이미지 + 카운터 겹치기 위한 래퍼 */
        .image-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /*중앙정렬*/
        }

        .image-button img {
            width: 400px;
            max-width: 80%;
            height: auto;
            transition: transform 0.15s ease;
            cursor: pointer;
            will-change: transform;       /* transform만 바뀌게 해서 레이아웃 영향 최소화 */
        }
        .image-button img:active { transform: scale(0.97); }

        .image-button img.pop {
            animation: popBounce 280ms ease;
        }

        @keyframes popBounce {
            0%   { transform: scale(1); }
            40%  { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* 이미지 위 클릭 카운트 배지 */
        .click-count {
            margin-bottom: 8px;     /* 이미지와의 간격 */
            background-color: rgba(0,0,0,0.6);
            color: #fff;
            padding: 6px 12px;
            border-radius: 18px;
            font-size: 20px;
            font-weight: 800;
            text-shadow: 0 1px 2px rgba(0,0,0,0.35);
            pointer-events: none;
            user-select: none;
        }

        .leaderboard {
            margin-top: 160px;
            width: 80%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .leaderboard h2 {
            margin: 0 0 20px;
            text-align: center;
            color: #2c3e50;
        }
        .leaderboard ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard li {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 1em;
        }
        .leaderboard li:last-child {
            border-bottom: none;
        }

        .mymajor {
            font-weight: bold;
        }
    </style>
</head>
<body>
<!-- 상단 헤더 -->
<div class="header">
    <div th:if="${isLoggedIn}">
        <form th:action="@{/logout}" method="get">
            <button type="submit">로그아웃</button>
        </form>
    </div>

    <div th:unless="${isLoggedIn}" style="display: flex;">
        <form th:action="@{/login}" method="get">
            <button type="submit">로그인</button>
        </form>
        <form th:action="@{/register}" method="get">
            <button type="submit">회원가입</button>
        </form>
    </div>
</div> <!-- ← 헤더 닫힘 누락되어 있어 추가 -->

<!-- 중앙 컨텐츠 -->
<div class="center-container">
    <!-- 이미지 버튼 (오버레이 카운터 포함) -->
    <div class="image-button">
        <div class="image-wrapper">
            <div id="clickCount" class="click-count">0</div>
            <img id="puangImg" src="/images/poppuang-closed.png" alt="푸앙이" />

        </div>
    </div>

    <!-- 클릭 사운드: 짧은 효과음은 WAV/OGG 권장 (지금은 요청대로 /images 사용) -->
    <audio id="clickSound" src="/sound/pop.mp3" preload="auto"></audio>

    <script>
        const puangImg = document.getElementById('puangImg');
        const clickSound = document.getElementById('clickSound');
        const clickCountEl = document.getElementById('clickCount');
        let revertTimer = null;

        // 볼륨 (0.0~1.0)
        clickSound.volume = 0.9;

        // 카운트 유틸
        function setCount(n) {
            clickCountEl.textContent = Number.isFinite(n) ? n : 0;
        }
        function incCount() {
            const cur = parseInt(clickCountEl.textContent || '0', 10) || 0;
            setCount(cur + 1);
        }

        puangImg.addEventListener('click', () => {
            // 사운드 재생 (사용자 제스처이므로 대부분 브라우저에서 허용)
            try {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
            } catch (_) {}

            // 이미지 열림 + 팝 애니메이션
            puangImg.classList.remove('pop');
            puangImg.src = '/images/poppuang-open.png';
            // 애니메이션 재시작 트릭
            // eslint-disable-next-line no-unused-expressions
            puangImg.offsetWidth;
            puangImg.classList.add('pop');

            // 자동 닫힘
            if (revertTimer) clearTimeout(revertTimer);
            revertTimer = setTimeout(() => {
                puangImg.src = '/images/poppuang-closed.png';
                puangImg.classList.remove('pop');
            }, 200);

            // 클릭 카운트 처리 (서버 응답에 clicks 있으면 사용, 없으면 +1)
            fetch('/click', { method: 'POST' })
                .then(async (res) => {
                    try {
                        const data = await res.json();
                        if (data && typeof data.clicks === 'number') {
                            setCount(data.clicks);
                        } else {
                            incCount();
                        }
                    } catch (e) {
                        incCount();
                    }
                })
                .then(() => loadLeaderboard())
                .catch(err => {
                    console.error(err);
                    incCount();
                });
        });


        // 리더보드 불러오는 함수
        function loadLeaderboard() {
            fetch('/leaderboard')
                .then(res => res.json())
                .then(data => {
                    const ul = document.querySelector('.leaderboard ul');

                    let myMajor = "[[${myMajor}]]";
                    const myData = myMajor ? data.find(item => item.major === myMajor) : null;
                    const myRankInfo
                        = !myMajor // myMajor 변수가 null이거나 없을 때
                        ? `<li class="mymajor"><span> </span> <span>로그인 후 이용 가능</span> <span> </span></li>`
                        : `<li class="mymajor"><span>나의 학과</span> <span>${myMajor}</span> <span>${myData ? myData.clicks : 0}</span></li>`;
                    // myData가 없을 경우를 대비하여 ${myData.clicks} 대신 ${myData ? myData.clicks : 0}으로 안전하게 수정
                    // 나머지 리더보드
                    data.sort((a, b) => b.clicks - a.clicks)
                    const leaderboardItems = data
                        .map((item, i) =>
                            `<li><span>${i + 1}위</span> <span>${item.major}</span> <span>${item.clicks}</span></li>`
                        )
                        .join('');

                    // 위에 원하는 항목 추가 후 innerHTML 설정
                    ul.innerHTML = `
                        ${myRankInfo}
                        ${leaderboardItems}
                    `;
                })
                .catch(err => console.error('리더보드 로딩 실패:', err));
        }

        // 기존 sendClick() 함수 (이제 안씀)
        function sendClick() {
            fetch('/click', { method: 'POST' })
                .then(res => {
                    if (!res.ok) throw new Error('클릭 처리 실패!');
                    return loadLeaderboard(); // 클릭 후 리더보드 갱신
                })
                .catch(err => console.error(err));
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadLeaderboard();
        });
    </script>

    <!-- 리더보드 -->
    <div class="leaderboard">
        <h2>리더보드</h2>
        <ul></ul>
    </div>
</div>
</body>
</html>

