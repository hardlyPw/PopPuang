<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>팝푸앙</title>
    <style>
        /* <body> 태그의 style 부분을 아래 코드로 교체하세요 */
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;

            /* ✅ body 자체의 background 속성은 제거합니다. */

            /* ✅ body에 position: relative; 추가하여 가상요소의 기준점으로 만듭니다. */
            position: relative;

            /* ✅ 내용물이 가상요소 위로 올라오도록 합니다. */
            z-index: 1;
        }

        /* ✅ 배경 이미지를 위한 가상 요소 추가 */
        body::before {
            content: ''; /* 가상 요소 필수 속성 */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* 기존 background 속성들을 이쪽으로 이동 */
            background-image: url('/images/software_logo.jpg');
            background-repeat: no-repeat;
            background-size: 700px auto;

            /* 1. 위쪽 여백 주기 */
            background-position: center 200px; /* 50px는 원하는 만큼 조절 */

            /* 2. 흐림 효과 주기 */
            filter: blur(8px); /* 8px는 원하는 흐림 정도로 조절 */

            /* ✅ 내용 뒤로 보내기 위한 z-index 설정 */
            z-index: -1;

            /* ✅ 일부 브라우저에서 깜빡임 방지를 위한 트릭 */
            transform: scale(1.1);
        }

        /* header, center-container 등 나머지 스타일은 그대로 둡니다.
           body 스타일만 위 코드로 교체하면 됩니다.
        */

        .header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px;
            background-color: #004c97;
        }

        .header form {
            margin-left: 10px;
        }

        .header button {
            padding: 8px 16px;
            background-color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .header button:hover {
            background-color: #bdc3c7;
        }

        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }

        .image-button img {
            margin-top: 160px;
            width: auto;
            height: 400px;
            transition: transform 0.3s ease;
        }

        .image-button img:hover {
            transform: scale(1.05);
        }

        .leaderboard {
            margin-top: 60px;
            width: 80%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .leaderboard h2 {
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            color: #2c3e50;
        }

        .leaderboard ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard li {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 1em;
        }

        .leaderboard li:last-child {
            border-bottom: none;
        }
        .mymajor {
            font-weight: bold;
        }
    </style>
</head>
<body>
<!-- 상단 헤더 -->
<div class="header">
    <div th:if="${isLoggedIn}">
        <form th:action="@{/logout}" method="get">
            <button type="submit">로그아웃</button>
        </form>
    </div>

    <div th:unless="${isLoggedIn}" style="display: flex;">
        <form th:action="@{/login}" method="get">
            <button type="submit">로그인</button>
        </form>
        <form th:action="@{/register}" method="get">
            <button type="submit">회원가입</button>
        </form>
    </div>
</div>


<!-- 중앙 컨텐츠 -->
<div class="center-container">
    <!-- 이미지 버튼 클릭 시 Ajax 호출 -->
    <div class="image-button">
        <img
                id="puangImg"
                src="/images/poppuang-closed.png"
                alt="푸앙이"
                style="cursor:pointer;"
        />
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // 컨트롤러의 Model에서 myMajor 값을 JavaScript 변수로 가져옵니다.
        // 로그인하지 않았을 경우 myMajor는 null이 됩니다.
        const myMajor = /*[[${myMajor != null ? myMajor.name : null}]]*/ null;
        /*]]>*/
    </script>

    <script>
        // 토글 상태 관리 변수
        let isOpen = false;

        // 이미지 엘리먼트 참조
        const puangImg = document.getElementById('puangImg');


        // 클릭 핸들러 등록: 이미지 토글 + 클릭 카운트 로직
        puangImg.addEventListener('click', () => {
            // 1) 이미지 토글
            isOpen = !isOpen;
            puangImg.src = isOpen
                ? '/images/poppuang-open.png'
                : '/images/poppuang-closed.png';

            // 2) 기존 클릭 카운트 로직
            sendClick();
        });


        // 리더보드 불러오는 함수
        function loadLeaderboard() {
            fetch('/leaderboard')
                .then(res => res.json())
                .then(data => {
                    const ul = document.querySelector('.leaderboard ul');

                    // ✅ [수정] 쿠키 대신 위에서 선언한 myMajor 변수 사용
                    // const myMajor = getCookie("major"); // 이 줄 삭제

                    const myData = myMajor ? data.find(item => item.major === myMajor) : null;
                    const myRankInfo
                        = !myMajor // myMajor 변수가 null이거나 없을 때
                        ? `<li class="mymajor"><span> </span> <span>로그인 후 이용 가능</span> <span> </span></li>`
                        : `<li class="mymajor"><span>나의 학과</span> <span>${myMajor}</span> <span>${myData ? myData.clicks : 0}</span></li>`;
                    // myData가 없을 경우를 대비하여 ${myData.clicks} 대신 ${myData ? myData.clicks : 0}으로 안전하게 수정

                    // 나머지 리더보드 로직은 그대로
                    data.sort((a, b) => b.clicks - a.clicks)
                    const leaderboardItems = data
                        .map((item, i) =>
                            `<li><span>${i + 1}위</span> <span>${item.major}</span> <span>${item.clicks}</span></li>`
                        )
                        .join('');

                    ul.innerHTML = `
                        ${myRankInfo}
                        ${leaderboardItems}
                    `;
                })
                .catch(err => console.error('리더보드 로딩 실패:', err));
        }

        // 기존 sendClick() 함수
        function sendClick() {
            fetch('/click', { method: 'POST' })
                .then(res => {
                    if (!res.ok) throw new Error('클릭 처리 실패!');
                    return loadLeaderboard(); // 클릭 후 리더보드 갱신
                })
                .catch(err => console.error(err));
        }

        // 페이지 로드되면 리더보드 표시
        window.addEventListener('DOMContentLoaded', loadLeaderboard);
    </script>

    <!-- 리더보드 영역 -->
    <div class="leaderboard">
        <h2>리더보드</h2>
        <ul>

        </ul>
    </div>

</div>
</body>
</html>